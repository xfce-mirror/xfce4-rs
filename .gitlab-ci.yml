image: rust:1.77-slim-bookworm

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# Set overall pipeline rules to avoid duplicated pipelines
# https://docs.gitlab.com/ee/ci/yaml/index.html#exclude-jobs-with-rules-from-certain-pipelines
workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

stages:
#  - style
  - test

# TODO: enable this once warnings are fixed
style:
  stage: style
  script:
    - cargo clippy --no-deps -- -D warnings
    - cargo fmt --check

test:
  stage: test
  script:
    - cargo test --release --all-features --workspace
